<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Комуникация между обекти. Делегати и събития — 12б, ООП</title>
    <style>
        body {
            font-family: 'DejaVu Serif', 'Times New Roman', serif;
            line-height: 1.6;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f9f9f9;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            border-bottom: 3px solid #fd7e14;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        
        h2 {
            color: #34495e;
            border-left: 4px solid #fd7e14;
            padding-left: 15px;
            margin-top: 30px;
        }
        
        h3 {
            color: #2c3e50;
            margin-top: 25px;
        }
        
        ul {
            margin: 15px 0;
        }
        
        li {
            margin: 8px 0;
        }
        
        code {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        
        pre {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
            margin: 15px 0;
            font-size: 14px;
            line-height: 1.4;
        }
        
        pre code {
            background-color: transparent;
            color: inherit;
            padding: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .highlight {
            background-color: #fff3cd;
            padding: 15px;
            border-left: 4px solid #ffc107;
            margin: 15px 0;
        }
        
        .example {
            background-color: #e8f5e8;
            padding: 15px;
            border-left: 4px solid #28a745;
            margin: 15px 0;
        }
        
        .important {
            background-color: #f8d7da;
            padding: 15px;
            border-left: 4px solid #dc3545;
            margin: 15px 0;
        }
        
        .config {
            background-color: #e3f2fd;
            padding: 15px;
            border-left: 4px solid #2196f3;
            margin: 15px 0;
        }
        
        .patterns {
            background-color: #f3e5f5;
            padding: 15px;
            border-left: 4px solid #9c27b0;
            margin: 15px 0;
        }
        
        .security {
            background-color: #ffebee;
            padding: 15px;
            border-left: 4px solid #f44336;
            margin: 15px 0;
        }
        
        strong {
            color: #2c3e50;
        }
        
        .section-number {
            color: #fd7e14;
            font-weight: bold;
        }
        
        .format-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .format-card {
            background-color: #f8f9fa;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }
        
        .format-card h4 {
            color: #fd7e14;
            margin-top: 0;
        }
        
        @media print {
            body {
                background-color: white;
            }
            .container {
                box-shadow: none;
                padding: 0;
            }
            .format-comparison {
                display: block;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Комуникация между обекти. Делегати и събития — 12б, ООП</h1>

        <h2><span class="section-number">1. Увод</span></h2>
        <div class="important">
            <p>Делегатите и събитията са мощни механизми за комуникация между обекти в C#. Те позволяват слабо свързани системи, където обектите могат да комуникират без да знаят директно един за друг.</p>
        </div>

        <h2><span class="section-number">2. Какво са делегатите?</span></h2>
        <div class="config">
            <h4>Делегатите са:</h4>
            <ul>
                <li><strong>Типове за функции</strong> - референции към методи</li>
                <li><strong>Типобезопасни</strong> - компилаторът проверява сигнатурата</li>
                <li><strong>Множествено извикване</strong> - могат да съдържат множество методи</li>
                <li><strong>Анонимни методи</strong> - могат да се създават inline</li>
                <li><strong>Ламбда изрази</strong> - могат да се използват с делегати</li>
            </ul>
        </div>

        <h2><span class="section-number">3. Дефиниране и използване на делегати</span></h2>
        
        <div class="config">
            <h4>Синтаксис на делегатите:</h4>
            <ul>
                <li><strong>delegate</strong> - ключова дума за дефиниране</li>
                <li><strong>Сигнатура</strong> - тип на връщане и параметри</li>
                <li><strong>Инстанциране</strong> - създаване на обект от делегат</li>
                <li><strong>Извикване</strong> - изпълнение на методите</li>
            </ul>
        </div>

        <div class="example">
            <h4>Основни примери с делегати:</h4>
            <pre><code>// Дефиниране на делегат
delegate int MathOperation(int x, int y);
delegate void DisplayMessage(string message);
delegate bool ValidationRule(string input);

// Клас с методи за делегати
class MathHelper {
    public static int Add(int x, int y) {
        Console.WriteLine($"Събиране: {x} + {y}");
        return x + y;
    }
    
    public static int Multiply(int x, int y) {
        Console.WriteLine($"Умножение: {x} * {y}");
        return x * y;
    }
    
    public static int Subtract(int x, int y) {
        Console.WriteLine($"Изваждане: {x} - {y}");
        return x - y;
    }
}

class MessageHelper {
    public static void PrintToConsole(string message) {
        Console.WriteLine($"Конзола: {message}");
    }
    
    public static void PrintToFile(string message) {
        Console.WriteLine($"Файл: {message}");
    }
    
    public static void PrintToDatabase(string message) {
        Console.WriteLine($"База данни: {message}");
    }
}

class ValidationHelper {
    public static bool IsNotEmpty(string input) {
        return !string.IsNullOrEmpty(input);
    }
    
    public static bool IsEmail(string input) {
        return input.Contains("@") && input.Contains(".");
    }
    
    public static bool IsLongEnough(string input) {
        return input.Length >= 5;
    }
}

// Използване на делегати
MathOperation operation = MathHelper.Add;
int result = operation(5, 3);
Console.WriteLine($"Резултат: {result}");

// Промяна на делегата
operation = MathHelper.Multiply;
result = operation(4, 6);
Console.WriteLine($"Резултат: {result}");

// Множествено извикване
DisplayMessage display = MessageHelper.PrintToConsole;
display += MessageHelper.PrintToFile;
display += MessageHelper.PrintToDatabase;

display("Важно съобщение");

// Валидация с делегати
ValidationRule validator = ValidationHelper.IsNotEmpty;
validator += ValidationHelper.IsEmail;
validator += ValidationHelper.IsLongEnough;

string email = "user@example.com";
bool isValid = validator(email);
Console.WriteLine($"Email '{email}' е валиден: {isValid}");</code></pre>
        </div>

        <h2><span class="section-number">4. Вградени делегати</span></h2>
        
        <div class="config">
            <h4>Основни вградени делегати:</h4>
            <ul>
                <li><strong>Action</strong> - не връща стойност (void)</li>
                <li><strong>Func&lt;T&gt;</strong> - връща стойност от тип T</li>
                <li><strong>Predicate&lt;T&gt;</strong> - връща bool (за условия)</li>
                <li><strong>Comparison&lt;T&gt;</strong> - за сравняване на два обекта</li>
            </ul>
        </div>

        <div class="example">
            <h4>Примери с вградени делегати:</h4>
            <pre><code>// Action делегати
Action<string> printAction = message => Console.WriteLine($"Action: {message}");
Action<int, int> mathAction = (x, y) => Console.WriteLine($"Сума: {x + y}");

printAction("Здравей от Action!");
mathAction(10, 20);

// Func делегати
Func<int, int, int> addFunc = (x, y) => x + y;
Func<string, string, string> concatFunc = (s1, s2) => s1 + " " + s2;
Func<int, bool> isEvenFunc = x => x % 2 == 0;

Console.WriteLine($"Събиране: {addFunc(5, 3)}");
Console.WriteLine($"Свързване: {concatFunc("Здравей", "Свят")}");
Console.WriteLine($"4 е четно: {isEvenFunc(4)}");

// Predicate делегати
Predicate<int> isPositivePredicate = x => x > 0;
Predicate<string> isNotEmptyPredicate = s => !string.IsNullOrEmpty(s);

Console.WriteLine($"5 е положително: {isPositivePredicate(5)}");
Console.WriteLine($"'Здравей' не е празно: {isNotEmptyPredicate("Здравей")}");

// Comparison делегати
Comparison<int> compareNumbers = (x, y) => x.CompareTo(y);
Comparison<string> compareStrings = (s1, s2) => string.Compare(s1, s2);

Console.WriteLine($"Сравнение на 5 и 3: {compareNumbers(5, 3)}");
Console.WriteLine($"Сравнение на 'a' и 'b': {compareStrings("a", "b")}");

// Комбиниране на делегати
Action<string> combinedAction = printAction;
combinedAction += message => Console.WriteLine($"Допълнително: {message.ToUpper()}");
combinedAction("Тест на комбиниране");</code></pre>
        </div>

        <h2><span class="section-number">5. Събития (Events)</span></h2>
        
        <div class="config">
            <h4>Събитията са:</h4>
            <ul>
                <li><strong>Специализирани делегати</strong> - за уведомления</li>
                <li><strong>Безопасни</strong> - само класът може да ги извиква</li>
                <li><strong>Множествено абониране</strong> - множество слушатели</li>
                <li><strong>Автоматично отписване</strong> - при унищожаване на обекта</li>
                <li><strong>Стандартизирани</strong> - EventHandler&lt;T&gt; pattern</li>
            </ul>
        </div>

        <div class="example">
            <h4>Примери с събития:</h4>
            <pre><code>// Клас за банкова сметка с събития
class BankAccount {
    private decimal balance;
    private string accountNumber;
    
    public event EventHandler<decimal> BalanceChanged;
    public event EventHandler<string> TransactionCompleted;
    public event EventHandler<decimal> LowBalanceWarning;
    
    public decimal Balance {
        get { return balance; }
        private set {
            decimal oldBalance = balance;
            balance = value;
            
            // Извикване на събитието за промяна на баланса
            BalanceChanged?.Invoke(this, balance);
            
            // Проверка за ниско салдо
            if (balance < 100 && oldBalance >= 100) {
                LowBalanceWarning?.Invoke(this, balance);
            }
        }
    }
    
    public string AccountNumber {
        get { return accountNumber; }
    }
    
    public BankAccount(string accountNumber, decimal initialBalance = 0) {
        this.accountNumber = accountNumber;
        this.balance = initialBalance;
    }
    
    public void Deposit(decimal amount) {
        if (amount > 0) {
            Balance += amount;
            TransactionCompleted?.Invoke(this, $"Депозит от {amount:C}");
        }
    }
    
    public bool Withdraw(decimal amount) {
        if (amount > 0 && Balance >= amount) {
            Balance -= amount;
            TransactionCompleted?.Invoke(this, $"Теглене от {amount:C}");
            return true;
        }
        return false;
    }
}

// Клас за логиране на транзакции
class TransactionLogger {
    private List<string> transactions;
    
    public TransactionLogger() {
        transactions = new List<string>();
    }
    
    public void OnTransactionCompleted(object sender, string transaction) {
        string logEntry = $"[{DateTime.Now:HH:mm:ss}] {transaction}";
        transactions.Add(logEntry);
        Console.WriteLine($"LOG: {logEntry}");
    }
    
    public void DisplayTransactions() {
        Console.WriteLine("\n=== История на транзакциите ===");
        foreach (var transaction in transactions) {
            Console.WriteLine(transaction);
        }
    }
}

// Клас за мониторинг на баланса
class BalanceMonitor {
    public void OnBalanceChanged(object sender, decimal newBalance) {
        Console.WriteLine($"Монитор: Балансът е променен на {newBalance:C}");
    }
    
    public void OnLowBalanceWarning(object sender, decimal balance) {
        Console.WriteLine($"ПРЕДУПРЕЖДЕНИЕ: Ниско салдо! Текущ баланс: {balance:C}");
    }
}

// Използване
var account = new BankAccount("BG123456789", 1000);
var logger = new TransactionLogger();
var monitor = new BalanceMonitor();

// Абониране за събития
account.BalanceChanged += monitor.OnBalanceChanged;
account.TransactionCompleted += logger.OnTransactionCompleted;
account.LowBalanceWarning += monitor.OnLowBalanceWarning;

// Извършване на транзакции
account.Deposit(500);
account.Withdraw(200);
account.Withdraw(1000); // Това ще предизвика предупреждение
account.Withdraw(200);

// Показване на историята
logger.DisplayTransactions();</code></pre>
        </div>

        <h2><span class="section-number">6. Пълен пример - Система за уведомления</span></h2>
        
        <div class="highlight">
            <h4>Реален пример с делегати и събития:</h4>
            <pre><code>// Клас за продукт
class Product {
    public string Name { get; set; }
    public decimal Price { get; set; }
    public int Stock { get; set; }
    public string Category { get; set; }
    
    public Product(string name, decimal price, int stock, string category) {
        Name = name;
        Price = price;
        Stock = stock;
        Category = category;
    }
    
    public override string ToString() {
        return $"{Name} - {Price:C} (Наличност: {Stock})";
    }
}

// Клас за магазин с събития
class Store {
    private List<Product> products;
    private Dictionary<string, int> sales;
    
    public event EventHandler<Product> ProductAdded;
    public event EventHandler<Product> ProductSold;
    public event EventHandler<Product> LowStockWarning;
    public event EventHandler<string> CategoryAdded;
    
    public Store() {
        products = new List<Product>();
        sales = new Dictionary<string, int>();
    }
    
    public void AddProduct(Product product) {
        products.Add(product);
        ProductAdded?.Invoke(this, product);
        
        if (!sales.ContainsKey(product.Category)) {
            sales[product.Category] = 0;
            CategoryAdded?.Invoke(this, product.Category);
        }
    }
    
    public bool SellProduct(string productName, int quantity) {
        var product = products.FirstOrDefault(p => p.Name == productName);
        if (product != null && product.Stock >= quantity) {
            product.Stock -= quantity;
            sales[product.Category] += quantity;
            
            ProductSold?.Invoke(this, product);
            
            if (product.Stock < 5) {
                LowStockWarning?.Invoke(this, product);
            }
            
            return true;
        }
        return false;
    }
    
    public List<Product> GetProducts() {
        return new List<Product>(products);
    }
    
    public Dictionary<string, int> GetSales() {
        return new Dictionary<string, int>(sales);
    }
}

// Клас за статистика
class StatisticsManager {
    private int totalProducts;
    private int totalSales;
    private Dictionary<string, int> categorySales;
    
    public StatisticsManager() {
        totalProducts = 0;
        totalSales = 0;
        categorySales = new Dictionary<string, int>();
    }
    
    public void OnProductAdded(object sender, Product product) {
        totalProducts++;
        Console.WriteLine($"Статистика: Добавен продукт. Общо: {totalProducts}");
    }
    
    public void OnProductSold(object sender, Product product) {
        totalSales++;
        Console.WriteLine($"Статистика: Продаден продукт. Общо продажби: {totalSales}");
    }
    
    public void OnCategoryAdded(object sender, string category) {
        Console.WriteLine($"Статистика: Добавена нова категория: {category}");
    }
    
    public void DisplayStatistics() {
        Console.WriteLine("\n=== Статистика ===");
        Console.WriteLine($"Общо продукти: {totalProducts}");
        Console.WriteLine($"Общо продажби: {totalSales}");
    }
}

// Клас за инвентарно управление
class InventoryManager {
    private List<Product> lowStockProducts;
    
    public InventoryManager() {
        lowStockProducts = new List<Product>();
    }
    
    public void OnLowStockWarning(object sender, Product product) {
        if (!lowStockProducts.Contains(product)) {
            lowStockProducts.Add(product);
        }
        Console.WriteLine($"Инвентар: ПРЕДУПРЕЖДЕНИЕ за ниски наличности - {product}");
    }
    
    public void OnProductSold(object sender, Product product) {
        if (product.Stock >= 5 && lowStockProducts.Contains(product)) {
            lowStockProducts.Remove(product);
            Console.WriteLine($"Инвентар: Продуктът {product.Name} вече не е с ниски наличности");
        }
    }
    
    public void DisplayLowStockProducts() {
        Console.WriteLine("\n=== Продукти с ниски наличности ===");
        if (lowStockProducts.Count == 0) {
            Console.WriteLine("Няма продукти с ниски наличности");
        } else {
            foreach (var product in lowStockProducts) {
                Console.WriteLine(product);
            }
        }
    }
}

// Клас за отчети
class ReportGenerator {
    private List<string> reports;
    
    public ReportGenerator() {
        reports = new List<string>();
    }
    
    public void OnProductAdded(object sender, Product product) {
        string report = $"[{DateTime.Now:HH:mm:ss}] Добавен: {product.Name} в категория {product.Category}";
        reports.Add(report);
    }
    
    public void OnProductSold(object sender, Product product) {
        string report = $"[{DateTime.Now:HH:mm:ss}] Продаден: {product.Name} (останали: {product.Stock})";
        reports.Add(report);
    }
    
    public void OnCategoryAdded(object sender, string category) {
        string report = $"[{DateTime.Now:HH:mm:ss}] Нова категория: {category}";
        reports.Add(report);
    }
    
    public void GenerateReport() {
        Console.WriteLine("\n=== Дневен отчет ===");
        foreach (var report in reports) {
            Console.WriteLine(report);
        }
    }
}

// Клас за уведомления
class NotificationService {
    public void OnProductAdded(object sender, Product product) {
        Console.WriteLine($"Уведомление: Нов продукт '{product.Name}' е добавен в магазина!");
    }
    
    public void OnProductSold(object sender, Product product) {
        Console.WriteLine($"Уведомление: Продукт '{product.Name}' е продаден!");
    }
    
    public void OnLowStockWarning(object sender, Product product) {
        Console.WriteLine($"Уведомление: Продукт '{product.Name}' има ниски наличности ({product.Stock} броя)!");
    }
    
    public void OnCategoryAdded(object sender, string category) {
        Console.WriteLine($"Уведомление: Нова категория '{category}' е добавена!");
    }
}

// Използване
var store = new Store();
var statistics = new StatisticsManager();
var inventory = new InventoryManager();
var reports = new ReportGenerator();
var notifications = new NotificationService();

// Абониране за събития
store.ProductAdded += statistics.OnProductAdded;
store.ProductAdded += reports.OnProductAdded;
store.ProductAdded += notifications.OnProductAdded;

store.ProductSold += statistics.OnProductSold;
store.ProductSold += reports.OnProductSold;
store.ProductSold += inventory.OnProductSold;
store.ProductSold += notifications.OnProductSold;

store.LowStockWarning += inventory.OnLowStockWarning;
store.LowStockWarning += notifications.OnLowStockWarning;

store.CategoryAdded += statistics.OnCategoryAdded;
store.CategoryAdded += reports.OnCategoryAdded;
store.CategoryAdded += notifications.OnCategoryAdded;

// Добавяне на продукти
Console.WriteLine("=== Добавяне на продукти ===");
store.AddProduct(new Product("Laptop", 1500, 10, "Електроника"));
store.AddProduct(new Product("Книга", 25, 50, "Книги"));
store.AddProduct(new Product("Молив", 2, 100, "Канцеларски"));

// Продажби
Console.WriteLine("\n=== Продажби ===");
store.SellProduct("Laptop", 2);
store.SellProduct("Книга", 10);
store.SellProduct("Молив", 50);
store.SellProduct("Laptop", 8); // Това ще предизвика предупреждение

// Показване на статистика
statistics.DisplayStatistics();
inventory.DisplayLowStockProducts();
reports.GenerateReport();

// Показване на всички продукти
Console.WriteLine("\n=== Всички продукти ===");
foreach (var product in store.GetProducts()) {
    Console.WriteLine(product);
}</code></pre>
        </div>

        <h2><span class="section-number">7. Практически задачи</span></h2>
        <div class="highlight">
            <h4>Задачи за упражнение:</h4>
            <ul>
                <li><strong>Създай система за уведомления</strong> с делегати и събития</li>
                <li><strong>Имплементирай система за логиране</strong> с различни изходи</li>
                <li><strong>Направи система за мониторинг</strong> на производителността</li>
                <li><strong>Създай система за кеширане</strong> с уведомления за изтичане</li>
                <li><strong>Имплементирай система за валидация</strong> с различни правила</li>
            </ul>
        </div>

        <h2><span class="section-number">8. Заключение</span></h2>
        <div class="important">
            <p>Делегатите и събитията са мощни инструменти за създаване на слабо свързани, гъвкави и разширяеми системи. Те позволяват обектите да комуникират без да знаят директно един за друг.</p>
        </div>

        <div class="patterns">
            <h4>Ключови принципи:</h4>
            <ul>
                <li><strong>Слабо свързване</strong> - обектите не знаят директно един за друг</li>
                <li><strong>Типобезопасност</strong> - компилаторът проверява сигнатурата</li>
                <li><strong>Множествено извикване</strong> - един делегат може да съдържа множество методи</li>
                <li><strong>Събития</strong> - специализирани делегати за уведомления</li>
                <li><strong>Разширяемост</strong> - лесно добавяне на нови слушатели</li>
            </ul>
        </div>
    </div>
</body>
</html>




